{
  "name": "Event",
  "tagline": "Event",
  "body": "# Notes\r\n\r\nThe process of creating the _Event_ entity type is documented below in the steps\r\nthat it takes to get from one branch to the next with notes for each step. Note\r\nthat the actual code in the branches is more not identical to the code snippets\r\ngiven here, although it is functionally equivalent.\r\n\r\n## Minimal entity type\r\nBranch: `00-empty-module` → `01-minimal-entity-type`\r\n\r\n* Create `src` directory\r\n  * `src` for all object-oriented code\r\n  * `.module` (and other files) outside, like in Drupal 7\r\n\r\n* Create `src/Entity` directory\r\n  * Subdirectories in `src` for organization\r\n  * Some directories have special meaning\r\n  * Drupal looks in `Entity` for entity types.\r\n\r\n* Create `src/Entity/Event.php` file and add the following:\r\n  ```php\r\n  class Event {}\r\n  ```\r\n  * File name corresponds to class name\r\n\r\n  ```php\r\n  namespace Drupal\\event\\Entity;\r\n  ```\r\n  * Namespace corresponds to directory structure\r\n  * PSR-4\r\n  * PSR-0\r\n\r\n  ```php\r\n  extends ContentEntityBase\r\n  ```\r\n  * Base classes as a tool for code reuse\r\n\r\n  ```php\r\n  use Drupal\\Core\\Entity\\ContentEntityBase;\r\n  ```\r\n  * Corresponds to namespace\r\n\r\n  ```php\r\n  * @ContentEntityType(\r\n  *   id = \"event\",\r\n  * )\r\n  ```\r\n  * Annotations as a way to provide metadata for code\r\n  * cmp. @param/@return/...\r\n  * Doctrine\r\n\r\n  ```php\r\n  *   label = @Translation(\"Event\"),\r\n  ```\r\n  * Translation in annotations\r\n  * Nested annotations\r\n\r\n  ```php\r\n  *   base_table = \"event\",\r\n  *   entity_keys = {\r\n  *     \"id\" = \"id\",\r\n  *     \"uuid\" = \"uuid\",\r\n  *   },\r\n  ```\r\n  * Top-level keys are not quoted, but keys in mappings are quoted\r\n\r\n* Update entity/field definitions\r\n  * `{event}` table created\r\n  * `id` and `uuid` columns\r\n\r\n* Try out event CRUD\r\n  * Create and save an event\r\n    * Row in `{event}` table\r\n  * Load an event by ID and print ID and UUID\r\n  * Delete an event\r\n      * Row in `{event}` table gone\r\n\r\n\r\n## Base field definitions\r\nBranch: `01-minimal-entity-type` → `02-base-field-definitions`\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  use Drupal\\Core\\Entity\\EntityTypeInterface;\r\n\r\n  public static function baseFieldDefinitions(EntityTypeInterface $entity_type) {\r\n    $fields = parent::baseFieldDefinitions($entity_type);\r\n\r\n    return $fields;\r\n  }\r\n  ```\r\n  * Interfaces as contracts to define behavior\r\n  * Overriding base implementation allows specialization while still having code reuse\r\n  * Static functions\r\n\r\n  ```php\r\n  use Drupal\\Core\\Field\\BaseFieldDefinition;\r\n\r\n  $fields['title'] = BaseFieldDefinition::create('string');\r\n  ```\r\n  * cmp. `new BaseFieldDefinition('string');`\r\n  * Field type discoverability:\r\n    * Navigate to \"FieldType\" annotation class on api.drupal.org\r\n    * Click on list of annotated classes\r\n    * Pick appropriate class and find plugin ID\r\n\r\n  ```php\r\n  ->setLabel(t('Title'))\r\n  ```\r\n  * cmp. definition object ↔ info array\r\n  * `t()` generally discouraged, but unavoidable in static functions\r\n\r\n  ```php\r\n  use Drupal\\datetime\\Plugin\\Field\\FieldType\\DateTimeItem;\r\n\r\n  $fields['date'] = BaseFieldDefinition::create('datetime')\r\n    ->setLabel(t('Date'))\r\n    ->setSetting('datetime_type' => DateTimeItem::DATETIME_TYPE_DATE);\r\n  $fields['description'] = BaseFieldDefinition::create('text_long')\r\n    ->setLabel(t('Description'));\r\n  ```\r\n  * Setting discoverability:\r\n    * View `defaultStorageSettings` or `defaultFieldSettings` method on field item class\r\n  * Fields can have multiple properties\r\n  * Property discoverability\r\n    * View `propertyDefinitions` method on field item class\r\n\r\n  ```php\r\n  *     \"label\" = \"title\",\r\n  ```\r\n\r\n  ```php\r\n  ->setRequired(TRUE)\r\n  ```\r\n\r\n* Apply entity updates\r\n  * `title`, `date`, `description__value`, `description__format` columns\r\n  * Load an event set title, date, and description and save\r\n\r\n\r\n## Interface\r\nBranch: `02-base-field-definitions` → `03-interface`\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```\r\n  public function getTitle() {\r\n    return $this->get('title')->value;\r\n  }\r\n\r\n  public function setTitle($title) {\r\n    $this->set('title', $title);\r\n  }\r\n\r\n  public function getDate() {\r\n    return $this->get('date')->date;\r\n  }\r\n\r\n  public function setDate(\\DateTimeInterface $date) {\r\n    $this->set('date', $date->format(DATETIME_DATE_STORAGE_FORMAT));\r\n  }\r\n  ```\r\n  * getter and setter methods allow formulating semantic APIs\r\n\r\n  ```php\r\n  public function getDescription() {\r\n    return $this->get('description')->processed;\r\n  }\r\n\r\n  public function setDescription($description, $format) {\r\n    $this->set('description', [\r\n      'value' => $description,\r\n      'format' => $format,\r\n    ]);\r\n  }\r\n  ```\r\n  * Text and text format must always passed along together for security\r\n\r\n* Create `src/Event/EventInterface.php` with the following code:\r\n  ```php\r\n  namespace Drupal\\event\\Entity;\r\n\r\n  use Drupal\\Core\\Entity\\ContentEntityInterface;\r\n\r\n  interface EventInterface extends ContentEntityInterface {\r\n\r\n    public function getTitle();\r\n\r\n    public function setTitle($title);\r\n\r\n    public function getDate();\r\n\r\n    public function setDate(\\DateTimeInterface $date);\r\n\r\n    public function getDescription();\r\n\r\n    public function setDescription($description, $format);\r\n\r\n  }\r\n  ```\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  implements EventInterface\r\n  ```\r\n\r\n* Test the new API\r\n  * Load an event set title, date, and description using the methods and save\r\n\r\n\r\n## View builder\r\nBranch: `03-interface` → `04-view-builder`\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  *   handlers = {\r\n  *     \"view_builder\" = \"Drupal\\Core\\Entity\\EntityViewBuilder\",\r\n  *   },\r\n  * )\r\n  ```\r\n\r\n  ```php\r\n  *     \"route_provider\" = {\r\n  *       \"html_default\" = \"Drupal\\Core\\Entity\\Routing\\DefaultHtmlRouteProvider\",\r\n  *     },\r\n\r\n  *   links = {\r\n  *     \"canonical\" = \"/events/{event}\"\r\n  *   },\r\n  ```\r\n\r\n* Rebuild caches\r\n* Visit `/event/{event}`\r\n  * Access control is not defined yet\r\n\r\n* Add a `event.permissions.yml` with the following:\r\n  ```yaml\r\n  administer events:\r\n    title: 'Administer events'\r\n  ```\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n\r\n  ```php\r\n  *   admin_permission = \"administer events\",\r\n  ```\r\n\r\n* Rebuild caches\r\n* Visit `/event/{event}`\r\n* Add the following to `src/Entity/Event.php`:\r\n\r\n  ```php\r\n  ->setDisplayOptions('view', [\r\n    'label' => 'inline',\r\n    'type' => 'datetime_default',\r\n    'settings' => [\r\n      'format_type' => 'html_date',\r\n    ],\r\n    'weight' => 0,\r\n  ])\r\n\r\n  ->setDisplayOptions('view', [\r\n    'label' => 'hidden',\r\n    'weight' => 5,\r\n  ])\r\n  ```\r\n  * cmp. _Manage display_ table\r\n  * Formatter discoverability:\r\n    * Navigate to \"FieldFormatter\" annotation class on api.drupal.org\r\n    * Click on list of annotated classes\r\n    * Pick appropriate class and find plugin ID\r\n  * Formatter settings discoverability:\r\n    * View `defaultSettings` method on formatter class\r\n\r\n* Visit _Recent log messages_ page\r\n  * Warning due to missing `event` theme hook\r\n\r\n* Add a `event.module` with the following:\r\n  ```php\r\n  function event_theme($existing, $type, $theme, $path) {\r\n    return [\r\n      'event' => [\r\n        'render element' => 'elements',\r\n        'file' => 'event.theme.inc',\r\n      ],\r\n    ];\r\n  }\r\n  ```\r\n* Add a `event.theme.inc` with the following:\r\n  ```php\r\n  use Drupal\\Core\\Render\\Element;\r\n\r\n  function template_preprocess_event(&$variables) {\r\n    foreach (Element::children($variables['elements']) as $key) {\r\n      $variables['content'][$key] = $variables['elements'][$key];\r\n    }\r\n  }\r\n  ```\r\n\r\n* Add a `templates` directory\r\n* Add a `templates/event.html.twig` with the following:\r\n  ```twig\r\n  <div{{ attributes }}>\r\n    {{ content }}\r\n  </div>\r\n  ```\r\n\r\n* Visit `/event/{event}`\r\n* Visit _Recent log messages_ page\r\n\r\n\r\n## Forms\r\nBranch: `04-view-builder` → `05-forms`\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  *     \"form\" = {\r\n  *       \"add\" = \"Drupal\\Core\\Entity\\ContentEntityForm\",\r\n  *       \"edit\" = \"Drupal\\Core\\Entity\\ContentEntityForm\",\r\n  *       \"delete\" = \"Drupal\\Core\\Entity\\ContentEntityDeleteForm\",\r\n  *     },\r\n  ```\r\n\r\n  ```php\r\n   *     \"add-form\" = \"/admin/content/events/add\",\r\n   *     \"edit-form\" = \"/admin/content/events/manage/{event}\",\r\n   *     \"delete-form\" = \"/admin/content/events/manage/{event}/delete\",\r\n  ```\r\n\r\n* Visit `/admin/content/events/add`\r\n\r\n  ```php\r\n  ->setDisplayOptions('form', ['weight' => 0])\r\n\r\n  ->setDisplayOptions('form', ['weight' => 5])\r\n\r\n  ->setDisplayOptions('form', ['weight' => 10])\r\n  ```\r\n\r\n* Rebuild caches\r\n* Visit `/admin/content/events/add`\r\n* Visit `/admin/content/events/manage/{event}/`\r\n* Visit `/admin/content/events/manage/{event}/delete`\r\n\r\n## List builder\r\nBranch: `05-forms` → `06-list-builder`\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  *     \"list_builder\" = \"Drupal\\Core\\Entity\\EntityListBuilder\",\r\n  ```\r\n\r\n  ```php\r\n  *     \"collection\" = \"/admin/content/events\",\r\n  ```\r\n  * Collection routes are not (yet) automatically generated\r\n\r\n* Add a `src/Routing` directory\r\n* Add a `src/Routing/CollectionHtmlRouteProvider` with the following:\r\n\r\n  ```php\r\n  namespace Drupal\\event\\Routing;\r\n\r\n  use Drupal\\Core\\Entity\\EntityTypeInterface;\r\n  use Drupal\\Core\\Entity\\Routing\\EntityRouteProviderInterface;\r\n  use Symfony\\Component\\Routing\\RouteCollection;\r\n  use Symfony\\Component\\Routing\\Route;\r\n\r\n  class EventCollectionHtmlRouteProvider implements EntityRouteProviderInterface {\r\n\r\n    public function getRoutes(EntityTypeInterface $entity_type) {\r\n      $routes = new RouteCollection();\r\n      if ($entity_type->hasListBuilderClass() && $entity_type->hasLinkTemplate('collection') && $entity_type->getAdminPermission()) {\r\n        $entity_type_id = $entity_type->id();\r\n\r\n        $route = new Route($entity_type->getLinkTemplate('collection'));\r\n        $route\r\n          ->setDefault('_entity_list', $entity_type_id)\r\n          ->setDefault('_title', 'Events')\r\n          ->setRequirement('_permission', $entity_type->getAdminPermission());\r\n\r\n        $routes->add(\"entity.$entity_type_id.collection\", $route);\r\n      }\r\n      return $routes;\r\n    }\r\n\r\n  }\r\n  ```\r\n<!-- TODO: Mention routing.yml (they made me do it) -->\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n\r\n  ```php\r\n  *       \"html_collection\" = \"Drupal\\event\\Routing\\EventCollectionHtmlRouteProvider\",\r\n  ```\r\n\r\n* Rebuild caches\r\n\r\n* Visit `/admin/content/events`\r\n\r\n* Add a `src/Entity/EventListBuilder` with the following:\r\n  ```php\r\n  namespace Drupal\\event\\Entity;\r\n\r\n  use Drupal\\Core\\Entity\\EntityInterface;\r\n  use Drupal\\Core\\Entity\\EntityListBuilder;\r\n\r\n  class EventListBuilder extends EntityListBuilder {\r\n\r\n    public function buildHeader() {\r\n      $header = [];\r\n      $header['title'] = $this->t('Title');\r\n      $header['date'] = $this->t('Date');\r\n      return $header + parent::buildHeader();\r\n    }\r\n\r\n    public function buildRow(EntityInterface $entity) {\r\n      /** @var \\Drupal\\event\\Entity\\EventInterface $event */\r\n      $row = [];\r\n      $row['title'] = $event->toLink();\r\n      $row['date'] = $event->getDate()->format(DATETIME_DATE_STORAGE_FORMAT);\r\n      return $row + parent::buildRow($entity);\r\n    }\r\n\r\n  }\r\n  ```\r\n  * Instead of hardcoding the format the `date.formatter` service should be\r\n    injected\r\n\r\n* Replace the list builder in `src/Entity/Event.php` with `Drupal\\event\\Entity\\EventListBuilder`\r\n* Rebuild caches\r\n* Visit `/admin/content/events`\r\n\r\n## Views data\r\nBranch: `06-list-builder` → `07-views-data`\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  *     \"views_data\" = \"Drupal\\views\\EntityViewsData\",\r\n  ```\r\n<!-- TODO: Mention views data sucks -->\r\n\r\n* Add a _Event_ view to replace the list builder\r\n\r\n## Administration links\r\nBranch: `07-views-data` → `08-admin-links`\r\n\r\n* Add a `event.links.menu.yml` with the following:\r\n  ```yaml\r\n  entity.event.collection:\r\n    title: 'Events'\r\n    route_name: entity.event.collection\r\n    parent: system.admin_content\r\n  ```\r\n  * Routes are separate from menu links\r\n  * `hook_menu()` in D7 → multiple `event.links.*.yml` files\r\n\r\n* Rebuild caches\r\n\r\n* Add a `event.links.task.yml` with the following:\r\n  ```yaml\r\n  entity.event.collection:\r\n    title: 'Events'\r\n    route_name: entity.event.collection\r\n    base_route: system.admin_content\r\n  ```\r\n\r\n* Rebuild caches\r\n* Visit `/admin/content/events`\r\n\r\n* Add a `event.links.action.yml` with the following:\r\n  ```ỳaml\r\n  entity.event.collection:\r\n    title: 'Add'\r\n    route_name: entity.event.add_form\r\n    appears_on: [entity.event.collection]\r\n  ```\r\n\r\n* Rebuild caches\r\n* Visit `/admin/content/events`\r\n\r\n* Add the following to `event.links.task.yml`:\r\n  ```yaml\r\n  entity.event.canonical:\r\n    title: 'View'\r\n    route_name: entity.event.canonical\r\n    base_route: entity.event.canonical\r\n  entity.event.edit_form:\r\n    title: 'Edit'\r\n    route_name: entity.event.edit_form\r\n    base_route: entity.event.canonical\r\n  entity.event.delete_form:\r\n    title: 'Delete'\r\n    route_name: entity.event.delete_form\r\n    base_route: entity.event.canonical\r\n  ```\r\n\r\n* Rebuild caches\r\n* Visit `/events/{event}`\r\n\r\n<!-- TODO: Add contextual links and form redirects -->\r\n\r\n## Access control\r\nBranch: `08-admin-links` → `09-access`\r\n\r\n* Add the following to `event.permissions.yml`:\r\n  ```yaml\r\n  create events:\r\n    title: 'Create events'\r\n  delete events:\r\n    title: 'Delete events'\r\n  edit events:\r\n    title: 'Edit events'\r\n  view events:\r\n    title: 'View events'\r\n  ```\r\n\r\n* Add a `src/Access` directory\r\n\r\n* Add a `src/Access/EventAccessControlHandler.php` with the following:\r\n  ```php\r\n  namespace Drupal\\event\\Access;\r\n\r\n  use Drupal\\Core\\Access\\AccessResult;\r\n  use Drupal\\Core\\Entity\\EntityAccessControlHandler;\r\n  use Drupal\\Core\\Entity\\EntityInterface;\r\n  use Drupal\\Core\\Session\\AccountInterface;\r\n\r\n  class EventAccessControlHandler extends EntityAccessControlHandler {\r\n\r\n    protected function checkCreateAccess(AccountInterface $account, array $context, $entity_bundle = NULL) {\r\n      $access_result = AccessResult::allowedIfHasPermission($account, 'create events');\r\n      return $access_result->orIf(parent::checkCreateAccess($account, $context, $entity_bundle));\r\n    }\r\n\r\n    protected function checkAccess(EntityInterface $entity, $operation, AccountInterface $account) {\r\n      switch ($operation) {\r\n        case \"view\":\r\n          $access_result = AccessResult::allowedIfHasPermission($account, 'view events');\r\n          break;\r\n\r\n        case \"update\":\r\n          $access_result = AccessResult::allowedIfHasPermission($account, 'edit events');\r\n          break;\r\n\r\n        case \"delete\":\r\n          $access_result = AccessResult::allowedIfHasPermission($account, 'delete events');\r\n          break;\r\n\r\n        default:\r\n          $access_result = AccessResult::neutral();\r\n          break;\r\n      }\r\n      return $access_result->orIf(parent::checkAccess($entity, $operation, $account));\r\n    }\r\n\r\n  }\r\n  ```\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  *     \"access\" = \"Drupal\\event\\Access\\EventAccessControlHandler\",\r\n  ```\r\n\r\n* Rebuild caches\r\n\r\n* Test permissions\r\n  * `create events`, `edit events`, or `delete events` do not grant\r\n    access to `/admin/content/events`\r\n\r\n## Additional fields\r\nBranch: `09-access` → `10-additional-fields`\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  use Drupal\\Core\\Field\\FieldStorageDefinitionInterface;\r\n\r\n  $fields['path'] = BaseFieldDefinition::create('path')\r\n    ->setLabel(t('Path'))\r\n    ->setDisplayOptions('form', ['weight' => 15]);\r\n\r\n  $fields['attendees'] = BaseFieldDefinition::create('entity_reference')\r\n    ->setLabel(t('Attendees'))\r\n    ->setSetting('target_type', 'user')\r\n    ->setCardinality(FieldStorageDefinitionInterface::CARDINALITY_UNLIMITED)\r\n    ->setDisplayOptions('form', ['weight' => 20]);\r\n  ```\r\n\r\n* Update entity/field definitions\r\n  * `{event__attendees}` table created\r\n  * `deleted`, `langcode`, `bundle`, `revision_id` not optional currently\r\n\r\n<!-- TODO: Add methods for managing attendees -->\r\n\r\n* Add the following to `src/Entity/EventInterface.php`:\r\n  ```php\r\n  use Drupal\\Core\\Entity\\EntityChangedInterface;\r\n  use Drupal\\user\\EntityOwnerInterface;\r\n\r\n  , EntityChangedInterface, EntityOwnerInterface\r\n  ```\r\n  * Changed tracking allows edit-locking\r\n  * Owners are used in entity reference, comment statistics, ...\r\n\r\n* Add the following to `src/Entity/Event.php`:\r\n  ```php\r\n  use Drupal\\Core\\Entity\\EntityChangedTrait;\r\n\r\n  use EntityChangedTrait;\r\n\r\n  public function getOwner() {\r\n    $this->get('owner')->entity;\r\n  }\r\n  public function setOwner(UserInterface $account) {\r\n    $this->set('owner', $account->id());\r\n  }\r\n  public function getOwnerId() {\r\n    $this->get('owner')->target_id;\r\n  }\r\n  public function setOwnerId($uid) {\r\n    $this->set('owner', $uid);\r\n  }\r\n\r\n  $fields['changed'] = BaseFieldDefinition::create('changed')\r\n    ->setLabel(t('Changed'));\r\n  $fields['owner'] = BaseFieldDefinition::create('entity_reference')\r\n    ->setLabel(t('Owner'))\r\n    ->setSetting('target_type', 'user')\r\n    ->setDefaultValueCallback(static::class . '::getDefaultOwnerIds');\r\n\r\n    public static function getDefaultOwnerIds() {\r\n      return [\\Drupal::currentUser()->id()];\r\n    }\r\n  ```\r\n\r\n<!-- TODO: Add status field -->\r\n\r\n* Update entity/field definitions\r\n  * `changed` and `owner` columns created\r\n\r\n## Configuration entities\r\nBranch: `10-additional-fields` → `11-bundles`\r\n\r\n* Create a `src/Entity/EventType.php` with the following:\r\n  ```php\r\n  namespace Drupal\\event\\Entity;\r\n\r\n  use Drupal\\Core\\Config\\Entity\\ConfigEntityBase;\r\n\r\n  /**\r\n   * @ConfigEntityType(\r\n   *   id = \"event_type\",\r\n   *   label = @Translation(\"Event type\"),\r\n   *   config_prefix = \"type\",\r\n   *   config_export = {\r\n   *     \"id\",\r\n   *     \"label\",\r\n   *   }\r\n   * )\r\n   */\r\n  class EventType extends ConfigEntityBase{\r\n\r\n    protected $id;\r\n\r\n    protected $label;\r\n\r\n  }\r\n  ```\r\n\r\n* Update entity/field definitions\r\n  * No schema change\r\n\r\n* Try out event type CRUD\r\n  * Create and save an event type\r\n    * Row in `{config}` table\r\n  * Load an event type by ID and print label\r\n  * Delete an event type\r\n    * Row in `{config}` table gone\r\n\r\n<!-- TODO: Config Translation ->\r\n<!-- TODO: Switch Translation & Revisions ->",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}